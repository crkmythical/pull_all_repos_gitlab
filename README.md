# GitLab 多组多仓库并发克隆与更新脚本

该 Bash 脚本用于从 GitLab 递归拉取指定 Token 账户可访问的所有 Group 及子组中的仓库，并支持拉取个人空间的项目（非 Group）。支持并发克隆，已存在仓库自动更新（完整分支和历史），并发控制，优雅退出，日志记录等功能。

---

## 功能特点

* 支持 GitLab 服务器地址自定义（默认 `https://gitlab.com`）
* 递归拉取所有 Group、子组内项目，及用户个人空间项目
* 支持并发限制：

  * 最大组并发（控制递归获取组数据并发）
  * 最大仓库克隆并发（控制仓库克隆并发）
* 已存在仓库自动更新：

  * 拉取完整历史（非浅克隆）
  * 拉取所有远程分支并在本地创建跟踪分支
  * 强制重置默认分支到远端最新状态
* 记录所有成功克隆仓库 SSH URL 到 `repos.log`
* 失败的仓库记录到 `repos_fail.log`
* 支持优雅退出，捕获 SIGINT / SIGTERM，安全终止所有后台任务
* 进度实时显示（默认每5秒刷新一次）

---

## 环境依赖

* Bash (推荐 Bash 4+)
* curl
* git
* jq (用于处理 GitLab API JSON 数据)

---

## 使用说明

### 下载脚本

```bash
curl -O https://yourserver/yourpath/gitlab_clone_all.sh
chmod +x gitlab_clone_all.sh
```

### 参数说明

| 参数 | 说明                           | 默认值             | 必填 |
| -- | ---------------------------- | --------------- | -- |
| -t | GitLab Personal Access Token | 无               | 是  |
| -d | 克隆基础目录                       | ./gitlab\_repos | 否  |
| -g | 最大组并发数（同时递归处理组）              | 3               | 否  |
| -r | 最大仓库克隆并发数                    | 5               | 否  |
| -h | 显示帮助信息                       | 无               | 否  |

### 示例

克隆所有仓库到默认目录，组并发3，仓库并发5：

```bash
./gitlab_clone_all.sh -t your_token_here
```

指定目录，最大组并发2，仓库并发4：

```bash
./gitlab_clone_all.sh -t your_token_here -d /tmp/repos -g 2 -r 4
```

---

## 退出与中断

* 脚本支持 Ctrl+C 中断，会优雅终止所有后台并发任务，确保无僵尸进程残留。
* 退出后，已成功克隆或更新的仓库会被记录在日志。

---

## 日志文件

* `repos.log`：成功克隆或更新仓库的 SSH URL，方便后续复用或检查
* `repos_fail.log`：克隆失败的仓库 URL，方便排查问题

日志文件位于克隆目录下。

---

## 注意事项

* 请保证 Token 具备足够权限访问目标组及项目的 API 权限。
* 大量仓库克隆和更新时，请确保有足够的磁盘空间和网络带宽。
* 脚本中并发参数可以根据服务器资源合理调整。
* 脚本未实现断点续传，建议结合日志及目录检查后重跑。

---

## 许可证

MIT License

---

如果你遇到任何问题或需要功能增强，欢迎反馈！

---

以上 README 模板，你可以根据实际情况再做调整，方便分享给团队或用于项目文档。需要我帮你做成 Markdown 文件，或者加入 CI/CD 集成说明，也可以告诉我！
